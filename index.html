<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gracey's Rewards</title>
  <style>
    #catchupTotal {
  text-align: center;
  font-size: 3em;
  font-weight: bold;
  color: #ffda75;
  text-shadow: 0 0 10px #fff38a;
  margin: 0.4em 0;
}
    .effect-overlay {
  opacity: 1;
  transition: opacity 2s ease;
}

.fadeout {
  opacity: 0 !important;
}
    #rewardPopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1600;
  padding: 1.2em 1.4em;
  background: rgba(0, 0, 0, 0.9);
  border-radius: 14px;
  text-align: center;
  color: white;
  font-size: 1em;
  box-shadow: 0 0 25px #fff4;
  animation: popBounce 0.8s ease, fadeHold 3s ease;
  max-width: 80%;
  max-height: 80%;
  body {
  overflow-x: hidden; /* horizontal only, keeps layout safe */
  overflow-y: auto;   /* vertical scroll allowed */
}
}

#rewardPopup img {
  max-width: 100px;
  max-height: 100px;
  margin: 0.6em auto 0;
  border-radius: 8px;
  border: 2px solid white;
  box-shadow: 0 0 10px #fff3;
  
}

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom right, #1a1a1a, #3a3a3a);
      color: #fff;
      margin: 0;
      padding: 2em 1em;
      transition: background 0.3s, color 0.3s;
    }
    h1 {
      text-align: center;
      color: #fff1a8;
      text-shadow: 0 0 15px #ff0;
    }
    #totalPoints {
  font-size: 2.5em;
  text-align: center;
  margin: 0.5em 0;
  color: #ffda75;
  transition: transform 0.3s ease, color 0.3s ease;
}
#totalPoints.animate {
  transform: scale(1.2);
  color: #fff79e;
}
    .controls, .log-entry {
      text-align: center;
      margin: 1em auto;
      max-width: 400px;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    input, button {
      padding: 0.6em;
      margin: 0.2em;
      font-size: 1em;
      border-radius: 6px;
      border: none;
    }
  #passwordPrompt {
  margin: 0 auto 1em;
  background: transparent;
  padding: 12px;
  border-radius: 10px;
  display: flex;
  flex-direction: row;
  gap: 8px;
  align-items: center;
  justify-content: center;
  max-width: 95vw;
  flex-wrap: wrap;
}
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background-color: #ccc;
      border-radius: 26px;
      transition: 0.3s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px; width: 20px;
      left: 3px; bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
    }
    input:checked + .slider {
      background-color: #66bb6a;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    #inventoryToggle {
      text-align: center;
      margin-top: 1em;
    }
    #inventoryButton {
      position: relative;
      font-size: 1.1em;
      padding: 10px 16px;
      background: #555;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      color: white;
      font-size: 0.75em;
      font-weight: bold;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      display: none;
    }
    #inventory {
      display: none;
      margin-top: 2em;
      text-align: center;
    }
    .item-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1em;
    }
   .item {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  background: #222;
  padding: 10px;
  border-radius: 10px;
  transition: transform 0.3s, box-shadow 0.3s;
  box-shadow: 0 0 10px #00000033;
}
.item:hover {
  transform: translateY(-4px);
  box-shadow: 0 0 12px #fffa;
}

   .item img {
  width: 100px;
  height: auto;
  border: 2px solid #ccc;
  border-radius: 6px;
  margin-bottom: 8px;
}
.item span {
  opacity: 0;
  animation: fadeInName 0.6s ease forwards;
}
@keyframes fadeInName {
  from { opacity: 0; transform: translateY(5px); }
  to   { opacity: 1; transform: translateY(0); }
}
    .horror { color: #ff4b4b; }
    .gothic { color: #c28bff; }
    .lace   { color: #87f2ff; }
    .belt   { color: #cccccc; }
    .baby   { color: #ffc1e3; }
    .dexter { color: #ff0000; }
    .butterfly { color: #b3f0ff; text-shadow: 0 0 8px #a3e9ff, 0 0 16px #ffffff; }
    .shadow { color: #ff003c; text-shadow: 0 0 8px #ff003c, 0 0 14px #000000; }
    .patch {
  color: #ffb3ec;
  text-shadow: 0 0 8px #fff, 0 0 15px #ff8ad4, 0 0 25px #ffd6f9;
  .sunmoon {
  color: #ffe599;
  text-shadow: 0 0 8px #fffac1, 0 0 15px #a6d0ff;
}

}
    #itemModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #itemModal img {
      max-width: 90%;
      max-height: 90%;
      border: 5px solid white;
      border-radius: 8px;
    }
    .effect-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 1500;
  pointer-events: none;
- opacity: 0.85;
}

    .scream { background: red; animation: flash 0.6s ease; }
    .bell { background: rgba(150, 0, 255, 0.7); animation: glow 1s ease; }
    .angelhum { background: rgba(255, 255, 255, 0.9); animation: fade 1.5s ease; }
    .ding { background: linear-gradient(45deg, gray, silver); animation: pulse 0.8s ease; }
    .kiss { background: pink; animation: pop 1s ease; }
    .slash { background: rgba(255, 0, 0, 0.7); animation: slash 0.7s ease; }
    #effect_ultimatepower
     {
      background: radial-gradient(circle, rgba(255,0,60,0.9) 0%, rgba(0,0,0,0.9) 100%);
      animation: shadowExplode 1.2s ease-out;
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1500;
      pointer-events: none;
    }
    
    .shadow-theme {
      background-color: black !important;
      color: #ff003c !important;
    }
    body.shaking {
      animation: shake 0.4s ease-in-out 3;
    }
.effect-overlay.magical {
  background: radial-gradient(ellipse at center, rgba(179,240,255,0.5) 0%, rgba(0,0,0,0.6) 100%);
  animation: shimmerFade 1.5s ease-in-out infinite alternate;
}

.effect-overlay.sunmoon {
  background: radial-gradient(ellipse at center, rgba(255, 255, 220, 0.07), rgba(0, 0, 0, 0.7));
  animation: sunMoonPulse 9.2s ease-in-out;
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 1500;
  pointer-events: none;
  overflow: hidden;
  opacity: 0;
  transition: opacity 1.2s ease;
}

.effect-overlay.sunmoon.visible {
  opacity: 0.85;
}


@keyframes sunMoonPulse {
  0% { transform: scale(1); opacity: 0.5; }
  50% { transform: scale(1.02); opacity: 0.9; }
  100% { transform: scale(1); opacity: 0.5; }
}

.sunmoon-orb {
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  opacity: 0.9;
   transform: scale(0.2);
  animation: floatOrb 2.8s ease-in-out forwards, pulseGlow 2.5s ease-in-out infinite, orbEntrance 0.8s ease-out;
}

@keyframes orbEntrance {
  0% { transform: scale(0.2); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.sunmoon-orb.sun {
  background: radial-gradient(circle, #fffcc4, #f6e58d);
  box-shadow: 0 0 15px #fffcc4, 0 0 30px #ffe599;
}

.sunmoon-orb.moon {
  background: radial-gradient(circle, #e0eaff, #b2caff);
  box-shadow: 0 0 12px #cfdfff, 0 0 24px #a6cfff;
}

@keyframes floatOrb {
  0% {
    transform: translateY(0px) scale(1);
    opacity: 1;
  }
  100% {
    transform: translateY(-200px) scale(0.8);
    opacity: 0;
  }
}

@keyframes orbDrift {
  0%   { transform: translateX(0); }
  25%  { transform: translateX(10px); }
  50%  { transform: translateX(-10px); }
  75%  { transform: translateX(5px); }
  100% { transform: translateX(0); }
}
@keyframes pulseGlow {
  0%   { box-shadow: 0 0 8px #fffcc4, 0 0 20px #ffe599; }
  50%  { box-shadow: 0 0 16px #fffac1, 0 0 35px #ffd; }
  100% { box-shadow: 0 0 8px #fffcc4, 0 0 20px #ffe599; }
}
.sunmoon-ripple {
  position: absolute;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(255, 255, 200, 0.2), transparent);
  animation: rippleExpand 2.5s ease-out forwards;
  pointer-events: none;
  opacity: 0.6;
}

@keyframes rippleExpand {
  0% {
    transform: scale(0.2);
    opacity: 0.4;
  }
  50% {
    transform: scale(1);
    opacity: 0.6;
  }
  100% {
    transform: scale(2.5);
    opacity: 0;
  }
}

.sunmoon-sparkle {
  position: absolute;
  width: 6px;
  height: 6px;
  background: white;
  border-radius: 50%;
  opacity: 0.7;
  box-shadow: 0 0 10px #fff, 0 0 18px #fff;
  animation: sparkleFlash 1.5s ease-in-out infinite;
}

@keyframes sparkleFlash {
  0%, 100% { opacity: 0.2; transform: scale(1); }
  50%      { opacity: 0.9; transform: scale(1.3); }
}



/* PATCH section — now safe and valid */
.effect-overlay.patch {
  background: linear-gradient(135deg, #ffb3ec, #ffc1f3, #e0c3fc, #a3f0ff);
  animation: patchShimmer 1.6s ease-in-out infinite;
  opacity: 0.9;
}

@keyframes patchShimmer {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

.patch-heart {
  position: absolute;
  width: 16px;
  height: 16px;
  background: pink;
  border-radius: 50% 50% 50% 50%;
  box-shadow: 0 0 10px #f0c, 0 0 20px #f0c;
  transform: rotate(-45deg);
  animation: floatHeart 1.8s ease-out forwards;
}

.patch-heart::after,
.patch-heart::before {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  background: pink;
  border-radius: 50%;
}

.patch-heart::before {
  top: -8px;
  left: 0;
}

.patch-heart::after {
  left: 8px;
  top: 0;
}

@keyframes floatHeart {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-120px) scale(0.7); opacity: 0; }
}
@keyframes shimmerFade {
  0% { opacity: 0.4; transform: scale(1); }
  100% { opacity: 0.9; transform: scale(1.05); }
}
#effect_magical_particles {
  z-index: 1501;
}

.particle {
  position: absolute;
  width: 8px;
  height: 8px;
  background: rgba(179, 240, 255, 0.9);
  border-radius: 50%;
  box-shadow: 0 0 8px rgba(179, 240, 255, 0.9);
  animation: floatParticle 3s ease-out forwards;
}

@keyframes floatParticle {
  0% {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  100% {
    transform: translateY(-100px) scale(0.5);
    opacity: 0;
  }
}

    @keyframes shadowExplode {
      0% { transform: scale(0.8); opacity: 0.6; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }
    @keyframes shake {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-5px, 5px); }
      50% { transform: translate(5px, -5px); }
      75% { transform: translate(-5px, 0); }
      100% { transform: translate(0, 0); }
    }
   
.point-fx {
  position: fixed;
  top: 90px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.5em;
  font-weight: bold;
  text-shadow: 0 0 5px #fff;
  opacity: 0;
  pointer-events: none;
  transition: transform 0.8s ease, opacity 0.8s ease;
  z-index: 2000;
}

.fx-glow {
  color: #90ff90;
  text-shadow: 0 0 10px #0f0, 0 0 20px #0f0;
}

.fx-sparkle {
  color: #b0f;
  text-shadow: 0 0 10px #f0f, 0 0 20px #fff;
  animation: sparkleAnim 1s ease-out;
}

.fx-bounce {
  color: #fff78a;
  animation: bouncePop 0.8s ease-out;
}

.fx-fire {
  color: #ff7733;
  text-shadow: 0 0 5px #f00;
  animation: fireBurst 0.6s ease-out;
}

.fx-lightning {
  color: #aaf;
  text-shadow: 0 0 10px #00f, 0 0 25px #fff;
  animation: zapCrack 0.6s ease-out;
}
.fx-minus1 {
  color: #ff8080;
  text-shadow: 0 0 6px #c00;
}

.fx-minus5 {
  color: #ff6666;
  text-shadow: 0 0 8px #900;
}

.fx-minus10 {
  color: #ff4444;
  text-shadow: 0 0 8px #800;
  font-style: italic;
}

.fx-minus20 {
  color: #ff2222;
  text-shadow: 0 0 10px #700;
  font-weight: bold;
}

.fx-minus50 {
  color: #ff0000;
  text-shadow: 0 0 12px #600;
  animation: shakeDown 0.8s ease-in-out;
}

@keyframes sparkleAnim {
  0% { transform: scale(1); }
  50% { transform: scale(1.3); }
  100% { transform: scale(1); }
}

@keyframes bouncePop {
  0% { transform: scale(0.6) translate(-50%, -50%); }
  50% { transform: scale(1.4) translate(-50%, -50%); }
  100% { transform: scale(1) translate(-50%, -50%); }
}

@keyframes fireBurst {
  0% { transform: scale(0.8); opacity: 1; }
  100% { transform: scale(1.4); opacity: 0; }
}

@keyframes zapCrack {
  0% { transform: rotate(0deg) scale(1); }
  25% { transform: rotate(5deg) scale(1.1); }
  50% { transform: rotate(-5deg) scale(1.1); }
  75% { transform: rotate(5deg) scale(1.2); }
  100% { transform: rotate(0deg) scale(1); }
}
@keyframes shakeDown {
  0%   { transform: translateY(0); }
  25%  { transform: translateY(4px); }
  50%  { transform: translateY(-4px); }
  75%  { transform: translateY(4px); }
  100% { transform: translateY(0); }
}
.point-float {
  position: absolute;
  font-size: 1.6em;
  font-weight: bold;
  pointer-events: none;
  opacity: 0;
  animation: floatUp 1s ease-out forwards;
  z-index: 9999;
}
@keyframes floatUp {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-30px); opacity: 0; }
}
@keyframes floatDown {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(30px); opacity: 0; }
}
.fx-glow   { color: #a0ffb2; text-shadow: 0 0 10px #0f0; }
.fx-sparkle{ color: #f6a0ff; text-shadow: 0 0 10px #f0f, 0 0 20px #fff; }
.fx-bounce { color: #fff78a; text-shadow: 0 0 6px #fff38a; }
.fx-fire   { color: #ff9966; text-shadow: 0 0 6px #ff4000; }
.fx-lightning { color: #aaf; text-shadow: 0 0 12px #33f, 0 0 25px #fff; }
.fx-negative {
  color: #ff4b4b;
  text-shadow: 0 0 8px #900;
}

@keyframes floatUp {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-30px); opacity: 0; }
}
#catchupOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9998;
}

#catchupPopup {
  background: #222;
  padding: 2em;
  border-radius: 10px;
  color: white;
  text-align: center;
  max-width: 90%;
  box-shadow: 0 0 20px #000;
}

#catchupPopup button {
  margin-top: 1em;
  padding: 0.5em 1em;
  font-size: 1em;
  background: #444;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

  </style>
</head>
<body>
<div id="startScreen" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: #111;
  color: white;
  z-index: 99999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0;
  margin: 0;
  box-sizing: border-box;
">
  <div style="
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    max-width: 90%;
    width: 100%;
    padding: 0 1em;
  ">
    <h2 style="
      margin: 0 0 1em 0;
      padding: 0;
      font-size: 1.8em;
      line-height: 1.2;
    ">Welcome to Gracey's Rewards</h2>

    <button onclick="enterApp()" style="
      padding: 0.8em 1.4em;
      font-size: 1.2em;
      background: #ffda75;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    ">Enter</button>
  </div>
</div>




  <div id="rewardPopup"></div>
  <!-- Dev Mode Toggle -->
<div style="text-align:center; margin-bottom: 1em;">
  <label class="switch">
    <input type="checkbox" id="devModeToggle" onchange="handleDevToggle()">
    <span class="slider"></span>
  </label>
  <span style="font-size: 0.9em;">Dev Mode</span>
</div>

<div id="passwordPrompt">
  <input type="password" id="passwordInput" placeholder="Password">
  <button onclick="checkPassword()">Unlock</button>
</div>

<h1>Gracey's Rewards</h1>

<div id="totalPoints">0</div>

<div class="controls" id="editControls" style="display:none;">
  <input type="text" id="reasonInput" placeholder="Reason..." />
  <div class="buttons">
    <button onclick="awardPoints(1)">+1</button>
    <button onclick="awardPoints(5)">+5</button>
    <button onclick="awardPoints(10)">+10</button>
    <button onclick="awardPoints(20)">+20</button>
    <button onclick="awardPoints(50)">+50</button>
  </div>
  <div class="buttons">
  <button onclick="awardPoints(-1)">-1</button>
  <button onclick="awardPoints(-5)">-5</button>
  <button onclick="awardPoints(-10)">-10</button>
  <button onclick="awardPoints(-20)">-20</button>
  <button onclick="awardPoints(-50)">-50</button>
</div>
</div>

<div id="logList"></div>

<div id="inventoryToggle">
  <button id="inventoryButton" onclick="toggleInventory()">
    🧺 Inventory <span id="badge">0</span>
  </button>
</div>
<div id="inventory">
  <h2>🎁 Rewards You've Earned</h2>
  <div class="item-grid" id="inventoryGrid"></div>
</div>

<div id="itemModal" onclick="this.style.display='none'">
  <img id="modalImage" src="" alt="Item Image">
</div>

<div id="rewardPopup"></div>

<!-- Effects -->
<div id="effect_scream" class="effect-overlay scream"></div>
<div id="effect_bell" class="effect-overlay bell"></div>
<div id="effect_angelhum" class="effect-overlay angelhum"></div>
<div id="effect_ding" class="effect-overlay ding"></div>
<div id="effect_kiss" class="effect-overlay kiss"></div>
<div id="effect_slash" class="effect-overlay slash"></div>
<div id="effect_ultimatepower" class="effect-overlay"></div>
<div id="effect_magical" class="effect-overlay magical"></div>
<div id="effect_magical_particles" class="effect-overlay" style="pointer-events: none;"></div>
<div id="effect_slash" class="effect-overlay slash"></div>
<div id="effect_ultimatepower" class="effect-overlay"></div>
<div id="effect_magical" class="effect-overlay magical"></div>
<div id="effect_magical_particles" class="effect-overlay" style="pointer-events: none;"></div>
<div id="effect_patch" class="effect-overlay"></div>
<div id="effect_patch_particles" class="effect-overlay" style="pointer-events: none;"></div>
<div id="effect_glimmer" class="effect-overlay" style="background: radial-gradient(circle, #ffe599, #fffac1, #a6d0ff);"></div>
<div id="effect_sunmoon" class="effect-overlay sunmoon"></div>


<!-- Firebase + App Script -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  const pointSounds = {
  plus1: new Audio("sounds/plus1.mp3"),
  plus5: new Audio("sounds/plus5.mp3"),
  plus10: new Audio("sounds/plus10.mp3"),
  plus20: new Audio("sounds/plus20.mp3"),
  plus50: new Audio("sounds/plus50.mp3"),
  minus1: new Audio("sounds/minus1.mp3"),
  minus5: new Audio("sounds/minus5.mp3"),
  minus10: new Audio("sounds/minus10.mp3"),
  minus20: new Audio("sounds/minus20.mp3"),
  minus50: new Audio("sounds/minus50.mp3")
};

const firebaseConfig = {
  apiKey: "AIzaSyCVxmCeRSheujRlo2ddOcUSaNYx1pq1gFY",
  authDomain: "gracey-s-rewards.firebaseapp.com",
  databaseURL: "https://gracey-s-rewards-default-rtdb.firebaseio.com",
  projectId: "gracey-s-rewards",
  storageBucket: "gracey-s-rewards.firebasestorage.app",
  messagingSenderId: "320157110840",
  appId: "1:320157110840:web:ede94a3e448889b55f0ccd",
  measurementId: "G-PRPNSPJELJ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let devMode = false;
let editUnlocked = false;
let rewards = [];
let unseenRewards = [];
let popupQueue = [];
let popupShowing = false;
let refPoints, refLog, refRewards;
let totalPoints = 0;

const rewardItems = [
  { name: "Horror Anime T-Shirt", points: 60, img: "https://m.media-amazon.com/images/I/B1pppR4gVKL._CLa%7C2140%2C2000%7C91wBHUyvxuL.png%7C0%2C0%2C2140%2C2000%2B0.0%2C0.0%2C2140.0%2C2000.0_AC_SX679_.png", class: "horror", sound: "scream" },
  { name: "Gothic Graphic Crop Top", points: 75, img: "https://m.media-amazon.com/images/I/61CH-IigCtL._AC_SY741_.jpg", class: "gothic", sound: "bell" },
  { name: "Marlboro Shadow T-Shirt", points: 85, img: "https://i0.wp.com/ellieshirt.com/wp-content/uploads/2025/04/SHADOW-SMOKING-THIS-POWER-CHANGES-ME-SHIRT-Sonic-the-Hedgehog-Marlboro-X-Shadow.gif?fit=1000%2C1000&ssl=1", class: "shadow", sound: "ultimatepower" },
  { name: "Striped Gothic Lace Shirt", points: 95, img: "https://m.media-amazon.com/images/I/61XF9gOHCQL._AC_SY879_.jpg", class: "lace", sound: "angelhum" },
  { name: "Metal Chain Belt", points: 115, img: "https://m.media-amazon.com/images/I/71rI66+vjeL._AC_SX679_.jpg", class: "belt", sound: "ding" },
  { name: "Mystic Butterfly Mug", points: 150, img: "https://i.etsystatic.com/24694628/r/il/fa052b/5704527119/il_1588xN.5704527119_2zap.jpg", class: "butterfly", sound: "magical" },
  { name: "Baby Girl Top", points: 150, img: "https://m.media-amazon.com/images/I/41ih9Eazx1L._AC_.jpg", class: "baby", sound: "kiss" },
  { name: "Dexter Action-Figure Set", points: 350, img: "https://i.ebayimg.com/images/g/qc0AAOSwhHNndjJG/s-l1600.webp", class: "dexter", sound: "slash" },
  {
  name: "Patch's Seal of Approval",
  points: 888,
  img: "https://i.imgur.com/oqFl0vb.png",
  class: "patch",
  sound: "patch_sparkle_v2"
},
{
  name: "Sun & Moon Touch Necklaces",
  points: 143,
  img: "https://totwooglobal.store/cdn/shop/files/totwoo_necklace_81baf88d-fa78-4d34-9873-4c545670a546.png?v=1723804524&width=1800",
  class: "sunmoon",
  sound: "sunmoon" // ✅ this matches <div id="effect_sunmoon">
}




  
];

function setupRefs() {
  refPoints = db.ref(devMode ? "dev_points" : "points");
  refLog = db.ref(devMode ? "dev_log" : "log");
  refRewards = db.ref(devMode ? "dev_rewards" : "rewards");

  refPoints.on("value", snap => {
  const newTotal = snap.val() || 0;

  if (!popupShowing && !editUnlocked) {
    const lastSeenTimestamp = parseInt(localStorage.getItem("lastSeenTimestamp")) || 0;
    
    refLog.once("value").then(snap => {
      const logs = snap.val() || [];
      const changes = logs.filter(log => {
        const ts = log.timestamp || 0;
        return ts > lastSeenTimestamp;
      });

      if (changes.length > 0) {
        const delta = changes.reduce((sum, entry) => sum + entry.amount, 0);
        showCatchupPopup(delta, changes);
      }
    });
  }

  totalPoints = newTotal;
  const pointsEl = document.getElementById("totalPoints");
  pointsEl.textContent = totalPoints;
  pointsEl.classList.add("animate");
  setTimeout(() => pointsEl.classList.remove("animate"), 400);
  updateInventory();
});


  refLog.on("value", snap => {
    const logs = snap.val() || [];
    const logList = document.getElementById("logList");
    logList.innerHTML = "";
    logs.forEach((entry, i) => {
      const div = document.createElement("div");
      div.className = "log-entry";
    const sign = entry.amount > 0 ? "+" : "";
div.textContent = `${sign}${entry.amount} - ${entry.reason}`;
div.style.color = entry.amount < 0 ? "#ff4b4b" : "#a0ffb2";

      if (editUnlocked) {
       const btn = document.createElement("button");
btn.textContent = "✕";
btn.style.cssText = "margin-left: 10px; background: crimson; color: white; border: none; border-radius: 4px; cursor: pointer;";
btn.onclick = () => deleteEntry(i);
div.appendChild(btn);
      }
      logList.appendChild(div);
    });
  });

  refRewards.on("value", snap => {
    rewards = snap.val() || [];
    updateInventory();
  });
}
function enterApp() {
  document.getElementById("startScreen").style.display = "none";

  // Unlock audio context (required for autoplay on iOS)
  const testAudio = new Audio("sounds/plus1.mp3");
  testAudio.play().catch(() => {});
}

function handleDevToggle() {
  const toggle = document.getElementById("devModeToggle");
  if (toggle.checked) {
    const pwd = prompt("Enter password to enable Dev Mode:");
    if (pwd === "ILoveGracey") {
      devMode = true;
      editUnlocked = true;
      document.getElementById("editControls").style.display = "block";
      document.getElementById("passwordPrompt").style.display = "none";
      setupRefs();
    } else {
      alert("Incorrect password.");
      toggle.checked = false;
    }
  } else {
    devMode = false;
    editUnlocked = false;
    document.getElementById("editControls").style.display = "none";
    document.getElementById("passwordPrompt").style.display = "block";
    setupRefs();
  }
}

function checkPassword() {
  primeAudio(); // <-- this line

  const pass = document.getElementById("passwordInput").value;
  if (pass === "ILoveGracey") {
    editUnlocked = true;
    document.getElementById("passwordPrompt").style.display = "none";
    document.getElementById("editControls").style.display = "block";
    updateLogDeleteButtons();
  } else {
    alert("Incorrect password.");
  }
}
function playPointSound(amount) {
  let key;
  const abs = Math.abs(amount);

  if (amount < 0) {
    key = `minus${abs}`;
  } else {
    key = `plus${amount}`;
  }

  const audio = pointSounds[key];
  if (audio) {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }

  localStorage.setItem("lastSeenTimestamp", Date.now());
}


function deleteEntry(index) {
  refLog.once("value").then(snap => {
    const logs = snap.val() || [];
    const entry = logs[index];
    if (!entry) return;
    logs.splice(index, 1);
    refLog.set(logs);
   const newTotal = Math.max(0, totalPoints - entry.amount);
refPoints.set(newTotal);

  });
}
function updateLogDeleteButtons() {
  const logs = document.querySelectorAll('.log-entry');
  logs.forEach((div, i) => {
    if (!div.querySelector('button')) {
      const btn = document.createElement("button");
      btn.textContent = "✕";
      btn.style.cssText = "margin-left: 10px; background: crimson; color: white; border: none; border-radius: 4px; cursor: pointer;";
      btn.onclick = () => deleteEntry(i);
      div.appendChild(btn);
    }
  });
}
function updateInventory() {
  const grid = document.getElementById("inventoryGrid");
  grid.innerHTML = "";
  const stored = localStorage.getItem("shownRewards");
  const shownRewards = stored ? JSON.parse(stored) : [];
  const justEarned = [];

  rewardItems.forEach(item => {
    const hasItem = totalPoints >= item.points;
    const alreadyEarned = rewards.includes(item.name);

    if (hasItem && !alreadyEarned) {
      rewards.push(item.name);
      unseenRewards.push(item.name);
      justEarned.push(item);
    } else if (!hasItem && alreadyEarned) {
      rewards = rewards.filter(r => r !== item.name);
      const index = shownRewards.indexOf(item.name);
      if (index !== -1) shownRewards.splice(index, 1);
    }

    if (hasItem) {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <img src="${item.img}" alt="${item.name}" onclick="showFullImage('${item.img}')">
        <span class="${item.class}">${item.name}</span>
      `;
      grid.appendChild(div);
    }
  });

  refRewards.set(rewards);

  justEarned.forEach(item => {
    if (!shownRewards.includes(item.name)) {
      popupQueue.push({ ...item, delayAfterPoints: true });
      shownRewards.push(item.name);
    }
  });

  localStorage.setItem("shownRewards", JSON.stringify(shownRewards));
  updateBadge();
  processPopupQueue();
}
const lastSeenPoints = parseInt(localStorage.getItem("lastSeenPoints")) || 0;
function showPopup(item) {
  const popup = document.getElementById("rewardPopup");
  popup.className = "";
  popup.innerHTML = "";

  const audio = new Audio("sounds/" + item.sound + ".mp3");

  const delays = {
    ultimatepower: 1300,
    angelhum: 200,
    bell: 500,
    ding: 100,
    kiss: 200,
    magical: 1000,
    scream: 400,
    patch: 0,
    sunmoon: 1000
  };

  const startDelay = (delays[item.sound] || 0) + 1000; // delay to let point sound finish

  setTimeout(() => {
    showEffect(item.sound);     // effect first
    setTimeout(() => {
      audio.play().catch(() => {});  // audio slightly after effect starts
      popup.innerHTML = `
        <strong>You just earned:</strong><br>
        <span class="${item.class}">${item.name}</span><br>
        <img src="${item.img}" alt="${item.name}">
      `;
      popup.style.display = "block";
    }, 300); // show popup 300ms after effect starts
  }, startDelay);

  audio.addEventListener("ended", () => {
    popup.style.display = "none";
    popupShowing = false;
    processPopupQueue();
  });
}


function showEffect(effectId) {
  const el = document.getElementById("effect_" + effectId);
  if (!el) return;

  const timing = {
    ultimatepower: { start: 1300, fadeStart: 5500, end: 7270 },
    angelhum: { start: 200, fadeStart: 1800, end: 2420 },
    bell: { start: 500, fadeStart: 2500, end: 3530 },
    ding: { start: 100, fadeStart: 1300, end: 1850 },
    kiss: { start: 200, fadeStart: 1100, end: 1630 },
    magical: { start: 1000, fadeStart: 6000, end: 7780 },
    scream: { start: 400, fadeStart: 5200, end: 6050 },
    patch: { start: 0, fadeStart: 1300, end: 1600 },
    sunmoon: { start: 1000, fadeStart: 9000, end: 10200 } // ✅ TIMING FIXED
  };

  const t = timing[effectId];
  if (!t) {
    el.style.display = "block";
    setTimeout(() => { el.style.display = "none"; }, 1500);
    return;
  }

  if (effectId === "patch") {
    const heartLayer = document.getElementById("effect_patch_particles");
    heartLayer.innerHTML = "";
    heartLayer.style.display = "block";

    for (let i = 0; i < 20; i++) {
      const heart = document.createElement("div");
      heart.className = "patch-heart";
      heart.style.left = Math.random() * 100 + "vw";
      heart.style.top = (50 + Math.random() * 30) + "vh";
      heart.style.animationDelay = (Math.random() * 1.2) + "s";
      heartLayer.appendChild(heart);
    }

    setTimeout(() => {
      heartLayer.style.display = "none";
      heartLayer.innerHTML = "";
    }, 1800);
  }

  if (effectId === "magical") {
    const particleContainer = document.getElementById("effect_magical_particles");
    particleContainer.innerHTML = "";
    particleContainer.style.display = "block";

    for (let i = 0; i < 25; i++) {
      const p = document.createElement("div");
      p.className = "particle";
      p.style.left = Math.random() * 100 + "vw";
      p.style.top = (50 + Math.random() * 30) + "vh";
      p.style.animationDelay = (Math.random() * 2) + "s";
      particleContainer.appendChild(p);
    }

    setTimeout(() => {
      particleContainer.style.display = "none";
      particleContainer.innerHTML = "";
    }, t.end);
  }

  setTimeout(() => {
    el.style.display = "block";
    el.classList.remove("fadeout");

    if (effectId === "ultimatepower") {
      document.body.classList.add("shaking");
      document.body.classList.add("shadow-theme");
    }

   if (effectId === "sunmoon") {
  const layer = document.getElementById("effect_sunmoon");
  layer.innerHTML = "";
  
  // Ensure it's reset first:
  layer.classList.remove("visible");
  layer.style.display = "block";
  layer.style.opacity = "0";  // force visible but transparent

  // Force reflow
  void layer.offsetWidth;

  // Now trigger transition
  layer.classList.add("visible");


  // Add orbs
  for (let i = 0; i < 20; i++) {
    const orb = document.createElement("div");
    orb.className = "sunmoon-orb " + (i % 2 === 0 ? "sun" : "moon");
    orb.style.left = Math.random() * 100 + "vw";
    orb.style.top = (60 + Math.random() * 20) + "vh";
    orb.style.animationDelay = (Math.random() * 1.4) + "s";
    layer.appendChild(orb);
  }

  // Add sparkles
  for (let i = 0; i < 16; i++) {
    const sparkle = document.createElement("div");
    sparkle.className = "sunmoon-sparkle";
    sparkle.style.left = Math.random() * 100 + "vw";
    sparkle.style.top = Math.random() * 100 + "vh";
    sparkle.style.animationDelay = (Math.random() * 2.5) + "s";
    layer.appendChild(sparkle);
  }

  // Add ripple
  for (let i = 0; i < 3; i++) {
    const ripple = document.createElement("div");
    ripple.className = "sunmoon-ripple";
    ripple.style.left = "calc(50% - 100px)";
    ripple.style.top = "calc(50% - 100px)";
    ripple.style.animationDelay = (i * 1.2) + "s";
    layer.appendChild(ripple);
  }

  // Fade out slowly
  setTimeout(() => {
    layer.classList.remove("visible");
  }, t.fadeStart - t.start);

  // Remove effect after done
  setTimeout(() => {
    layer.style.display = "none";
    layer.innerHTML = "";
  }, t.end - t.start);
}
    setTimeout(() => {
      el.classList.add("fadeout");
      if (effectId === "ultimatepower") {
        document.body.classList.remove("shaking");
        document.body.classList.remove("shadow-theme");
      }
    }, t.fadeStart - t.start);

    setTimeout(() => {
      el.style.display = "none";
      el.classList.remove("fadeout");
    }, t.end - t.start);

  }, t.start);
}
function processPopupQueue() {
  if (popupShowing || popupQueue.length === 0) return;
  popupShowing = true;

  const next = popupQueue.shift();

  // If reward is marked to delay until point sound finishes
  if (next.delayAfterPoints) {
    // Estimate safe delay: 1 second
    delayedPopup(next, 1000);
  } else {
    showPopup(next);
  }
}

function toggleInventory() {
  const inv = document.getElementById("inventory");
  const badge = document.getElementById("badge");
  if (inv.style.display === "none") {
    inv.style.display = "block";
    unseenRewards = [];
    badge.style.display = "none";
  } else {
    inv.style.display = "none";
  }
}

function updateBadge() {
  const badge = document.getElementById("badge");
  if (unseenRewards.length > 0) {
    badge.style.display = "inline-block";
    badge.textContent = unseenRewards.length;
  } else {
    badge.style.display = "none";
  }
}

function showFullImage(src) {
  document.getElementById("modalImage").src = src;
  document.getElementById("itemModal").style.display = "flex";
}
function getPointEffectClass(amount) {
  if (amount === 1) return "fx-glow";
  if (amount === 5) return "fx-sparkle";
  if (amount === 10) return "fx-bounce";
  if (amount === 20) return "fx-fire";
  if (amount === 50) return "fx-lightning";

  if (amount === -1) return "fx-minus1";
  if (amount === -5) return "fx-minus5";
  if (amount === -10) return "fx-minus10";
  if (amount === -20) return "fx-minus20";
  if (amount === -50) return "fx-minus50";

  return "";
}



function awardPoints(amount) {
  const reason = document.getElementById("reasonInput").value || "No reason";

  // Special reward for Patch
  if (reason.toLowerCase().includes("patch") && !rewards.includes("Patch's Seal of Approval")) {
    rewards.push("Patch's Seal of Approval");
    refRewards.set(rewards);
    popupQueue.push({
      name: "Patch's Seal of Approval",
      img: "https://i.imgur.com/oqFl0vb.png",
      class: "patch",
      sound: "patch_sparkle_v2"
    });
  }

  const newTotal = totalPoints + amount;
  refPoints.set(newTotal);

  refLog.once("value").then(snap => {
    const current = snap.val() || [];
    current.push({ amount, reason, timestamp: Date.now() });
    refLog.set(current);
  });

  const sign = amount > 0 ? "+" : "";
  showPointFloat(`${sign}${amount}`, amount);
  
  // Play point sound and delay reward popup
  const soundDuration = playPointSoundWithDelay(amount);
  
  // Delay processing reward popup until point sound finishes
  setTimeout(() => {
    updateInventory(); // triggers reward popups from queue if any
  }, soundDuration);
}
function showPointFloat(text, amount, container = document.body, centerOnScreen = false) {
  const div = document.createElement("div");
  const effectClass = getPointEffectClass(amount);
  div.className = "point-float " + effectClass;
  div.textContent = text;
  container.appendChild(div);

  let centerX, topY;

  if (centerOnScreen) {
    const floatWidth = div.offsetWidth;
    centerX = window.innerWidth / 2;
    topY = window.innerHeight / 2 + (amount < 0 ? 30 : -10);
    div.style.left = `${centerX - floatWidth / 2}px`;
    div.style.top = `${topY}px`;
  } else {
    const target = document.getElementById("totalPoints");
    const rect = target.getBoundingClientRect();
    const floatWidth = div.offsetWidth;
    centerX = rect.left + rect.width / 2 + window.scrollX;
    topY = rect.top + window.scrollY + (amount < 0 ? 30 : -10);
    div.style.left = `${centerX - floatWidth / 2}px`;
    div.style.top = `${topY}px`;
  }

  div.style.opacity = 1;
  div.style.animation = amount < 0 ? "floatDown 1s ease-out forwards" : "floatUp 1s ease-out forwards";

  setTimeout(() => div.remove(), 1000);
}


function playPointSoundWithDelay(amount) {
  let sound;
  const abs = Math.abs(amount);

  if (amount < 0) {
    switch (abs) {
      case 1: sound = "minus1"; break;
      case 5: sound = "minus5"; break;
      case 10: sound = "minus10"; break;
      case 20: sound = "minus20"; break;
      case 50: sound = "minus50"; break;
    }
  } else {
    switch (amount) {
      case 1: sound = "plus1"; break;
      case 5: sound = "plus5"; break;
      case 10: sound = "plus10"; break;
      case 20: sound = "plus20"; break;
      case 50: sound = "plus50"; break;
    }
  }

  if (sound) {
    const audio = new Audio(`sounds/${sound}.mp3`);
    audio.play().catch(() => {});
    localStorage.setItem("lastSeenTimestamp", Date.now());

    // Return estimated duration in ms (safe guess)
    return 1000;
  }

  return 0;
}

function showCatchupPopup(delta, changes) {
  const overlay = document.getElementById("catchupOverlay");
  const popup = document.getElementById("catchupPopup");
  const msg = document.getElementById("catchupMessage");
  msg.innerHTML = "";

  // Add large centered total points
  const totalEl = document.createElement("div");
  totalEl.textContent = totalPoints;
  totalEl.id = "catchupTotal";
  msg.appendChild(totalEl);

  overlay.style.display = "flex";

  let i = 0;
function nextEntry() {
  if (i >= changes.length) {
    const finalMsg = document.createElement("div");
    finalMsg.style.marginTop = "1em";
    finalMsg.style.fontSize = "1.2em";
    finalMsg.style.textAlign = "center";

    const moodMessages = {
      good: [
        "You're on a roll today! 🚀",
        "That’s the spirit — keep going!",
        "Nice work — Gracey would be proud!",
        "Killing it lately 🔥",
        "Solid effort. Keep pushing 💪"
      ],
      great: [
        "You crushed it! 💥",
        "This is some serious progress! 🌟",
        "Legendary stuff right there 😎",
        "Absolutely unstoppable today.",
        "You went beast mode."
      ],
      okay: [
        "Not bad, not bad 👌",
        "Making moves, even if they're small!",
        "Tiny steps forward still count!",
        "Momentum’s building. Keep it up.",
        "Some days just click!"
      ],
      weak: [
        "A little slip-up, huh?",
        "Could’ve been better...",
        "Eh. We’ve seen better days.",
        "You’re slipping a little.",
        "Not your best, be honest."
      ],
      bad: [
        "I'm not impressed. 😒",
        "This is looking rough.",
        "Yeah... no. Not good.",
        "Seriously?",
        "Try harder next time."
      ],
      awful: [
        "I'm actually disappointed. 😔",
        "What happened out there?",
        "I'm shaking my head.",
        "You sabotaged yourself. 😶",
        "No excuses. This was bad."
      ]
    };

    let moodTier;
    if (delta >= 30) moodTier = "great";
    else if (delta >= 10) moodTier = "good";
    else if (delta > 0) moodTier = "okay";
    else if (delta <= -30) moodTier = "awful";
    else if (delta <= -10) moodTier = "bad";
    else moodTier = "weak";

    const messages = moodMessages[moodTier];
    const moodText = messages[Math.floor(Math.random() * messages.length)];
    finalMsg.textContent = moodText;
    finalMsg.style.color = delta >= 0 ? "#a0ffb2" : "#ff6666";
    msg.appendChild(finalMsg);
    return;
  }

  const entry = changes[i];
  const amount = entry.amount;
  const reason = entry.reason || "No reason";
  const sign = amount > 0 ? "+" : "";

  showPointFloat(`${sign}${amount}`, amount, msg, true);
  playPointSound(amount);

  const reasonText = document.createElement("div");
  reasonText.style.fontSize = "1em";
  reasonText.style.fontWeight = "bold";
  reasonText.style.margin = "0.3em 0";
  reasonText.style.textAlign = "center";
  reasonText.textContent = `${sign}${amount} — ${reason}`;
  reasonText.style.color = amount < 0 ? "#ff4b4b" : "#a0ffb2";

  msg.appendChild(reasonText);

  i++;
  setTimeout(nextEntry, 1400);
}


  nextEntry();
}


function closeCatchupPopup() {
  document.getElementById("catchupOverlay").style.display = "none";
}
function primeAudio() {
  Object.values(pointSounds).forEach(audio => {
    audio.play().then(() => audio.pause()).catch(() => {});
  });
}
function delayedPopup(item, delayMs) {
  setTimeout(() => {
    showPopup(item);
  }, delayMs);
}

setupRefs();
window.addEventListener("beforeunload", () => {
  localStorage.setItem("lastSeenTimestamp", Date.now());
});
</script>
<audio id="pointSound" src="sounds/point.wav" preload="auto"></audio>
<div id="pointDelta" style="
  position: fixed;
  top: 90px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.5em;
  font-weight: bold;
  color: #90ff90;
  text-shadow: 0 0 5px #0f0;
  opacity: 0;
  pointer-events: none;
  transition: transform 0.8s ease, opacity 0.8s ease;
  z-index: 2000;
"></div>
<div id="catchupOverlay" style="display:none;">
  <div id="catchupPopup">
   <div id="catchupMessage">
  <div id="catchupTotal"></div>
</div>

    <button onclick="closeCatchupPopup()">Got it</button>
  </div>
</div>


</body>
</html>